<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>

// SIMPLIFIED NON-WORKING CODE -- what is the minimum to work?

var width = 960, height = 500;

// x.y.z().w()
var voronoi = d3.geom.voronoi().clipExtent([[0, 0], [width, height]]);

var canvas = d3.select("body").append("canvas")
    .attr("width", width)
    .attr("height", height);

var context = canvas.node().getContext("2d");

var image = new Image;
image.src = "starry-night.jpg";
image.onload = start;

function start() {
  context.drawImage(image, 0, 0);
  image = context.getImageData(0, 0, width, height);

  // instead of a Voronoi quadtree we use a simplfied quadtree using a perfectly even array of points

  // what is the object returned by Voroni samples??
  voronoi(samples).forEach(function(cell) {
    var x = Math.floor(cell.point[0]),
        y = Math.floor(cell.point[1]),
        i = (y * width + x) << 2;
    context.fillStyle = d3.rgb(image.data[i + 0], image.data[i + 1], image.data[i + 2]) + "";
    context.beginPath();
    context.moveTo(cell[0][0], cell[0][1]);
    for (var i = 1, n = cell.length; i < n; ++i) context.lineTo(cell[i][0], cell[i][1]);
    context.closePath();
    context.fill();
  });

  }

  var sample = bestCandidateSampler(width, height, 10, 10000),
      samples = [];

  while (s = sample()) samples.push(s);

  function bestCandidateSampler(width, height, numCandidates, numSamplesMax) {
        var numSamples = 0;

        var quadtree = d3.geom.quadtree()
            .extent([[0, 0], [width, height]])
            ([[Math.random() * width, Math.random() * height]]);

        // bestCandidateSampler returns a function!
        return function() {
          if (++numSamples > numSamplesMax) return;

          bestCandidate = [Math.random() * width, Math.random() * height]
          quadtree.add(bestCandidate);
          return bestCandidate;
      };
    }

</script>
